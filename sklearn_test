import numpy as np
import matplotlib.pyplot as plt
from sklearn.linear_model import LinearRegression

def fit_trend(year, value):
    """给定 year 和 value（可包含 NaN），返回：
       x_fit（用于绘图的平滑年份轴）
       y_fit（回归预测值）
       model（sklearn 模型）
    """
    # 去掉 NaN
    mask = ~np.isnan(year) & ~np.isnan(value)
    x = year[mask].reshape(-1,1)
    y = value[mask]

    # 拟合线性趋势
    model = LinearRegression()
    model.fit(x, y)

    # 生成平滑趋势线
    x_fit = np.linspace(x.min(), x.max(), 200).reshape(-1,1)
    y_fit = model.predict(x_fit)

    return x_fit, y_fit, model

data = np.genfromtxt('ClimObs_1918to2020.csv', skip_header = 1, delimiter = ',')

is_summer = (data[:,0] == 2)

Tbar = data[:,2]
Pre = data[:,3]
year = data[:,1]

x_fit,  y_fit, model = fit_trend(year, Tbar)

print("coef a =", model.coef_[0])

plt.figure(figsize=(10,5))

plt.plot(year, Tbar, label = 'data')
plt.plot(x_fit, y_fit, color = 'red', linewidth = 1, label = 'liner trend')
plt.xlabel('Year')
plt.ylabel('T')
plt.title('T by year')
plt.grid(True)
plt.show()
